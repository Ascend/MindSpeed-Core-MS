## 分布式调试使用说明

本说明介绍如何在分布式训练环境中使用调试断点功能，实现指定进程进入pdb交互调试，其它进程等待调试完成后再继续执行。

### 使用示例

以下例子展示如何在分布式场景调用断点调试接口。

1. **在模型启动脚本（例如 `pretrain_xxx.sh`）中加入调试设置**

   在执行 `msrun pretrain_gpt.py` 之前，加入以下两行命令：

   ```bash
   #添加如下两行
   source tools/debug_utils/dist_debug.sh
   exit
   ```

   这样可以在启动前加载调试配置，并暂停正常流程，等待调试过程完成。

2. **在代码中添加调试断点**

   在python代码希望调试的地方增加如下两行：

   ```python
   from tools import breakpoint_, clear_
   breakpoint_()
   ```

   **注意：如果是该行代码往下走会稳定报错的场景，可以使用**

   ```python
   breakpoint_(False)
   ```

3. **进入调试**
   正常启动pretrain_xxx.sh脚本，等待到达断点处。看见类似如下交互日志时，表明已进入断点调试模式：

   ```bash
   [1744769595.8194475]counter_file created: /tmp/debug_counter_0.txt
   --Return--
   > xxx/MindSpeed-Core-MS/MindSpeed-LLM/pdb_utils.py(26)breakpoint_()->None
   -> pdb.set_trace()
   (Pdb)
   ```

4. **此处调试完成后，调用 clear_() 解除其它进程的阻塞**

   ```python
   clear_()
   ```

   使得其他进程在对应位置停住，从而防止其他rank运行到报错位置导致scheduler杀死集群。

### pdb调试常用命令

pdb常用指令：[python pdb官方链接](https://docs.python.org/3/library/pdb.html#pdbcommand-help)

### 原理实现说明

如下流程图展示整个流程中各个进程的状态转换。
注意：流程图中左侧为调试进程，右侧为其他进程；图中分别标注“进入断点前”、
“进入调试状态”和“解除阻塞后”的状态。

```text
                           ┌─────────────────────────────┐
                           │    所有进程到达断点处         │
                           └─────────────────────────────┘
                                        │
                                        ▼
                           ┌─────────────────────────────┐
                           │   调用 breakpoint_() 函数    │
                           └─────────────────────────────┘
                                        │
                                        ▼
                           ┌─────────────────────────────┐
                           │ 判断当前进程的角色：         │
                           │ (是否为调试进程？)           │
                           └─────────────────────────────┘
                                        │
                   ┌────────────────────┴────────────────────────────┐
                   │                                                │
                   ▼                                                ▼
         ┌────────────────────────┐                    ┌────────────────────────┐
         │ 当前进程为调试进程     │                      │ 当前进程非调试进程      │
         │ (rank == MS_DEBUG_RANK)│                    │ (rank ≠ MS_DEBUG_RANK) │
         └────────────────────────┘                    └────────────────────────┘
                   │                                                │
                   │                                                │
         ┌────────────────────────┐                     ┌────────────────────────┐
         │ 检查临时文件counter_file│                     │ 根据 non_block 参数区分 │
         │ 是否存在：              │                     │ 分支处理：             │
         │ － 不存在，则创建       │                      └─────────────┬──────────┘
         │    counter_file        │                                    │
         └────────────────────────┘                                    │
                   │                                             ┌─────┴─────────┐
                   │                                             │               │
                   ▼                                             ▼               ▼
         ┌───────────────────────┐                ┌───────────────────┐   ┌────────────────────┐
         │ 打印创建日志           │                │ 非调试进程：        │   │ 非调试进程：       │
         └───────────────────────┘                │ non_block=False    │   │ non_block=True    │
                   │                               │ － 进入等待状态    │   │ － 直接跳过等待     │
                   │                               │   a. 等待文件创建  │   └────────────────────┘
                   │                               │   b. 循环等待文件  │           │
                   │                               │      被删除       │            │
                   │                               └───────────────────┘           │
                   │                                          │                    │
                   ▼                                          │                    ▼
         ┌────────────────────────┐                           │        ┌────────────────────────┐
         │ 调用 pdb.set_trace()   │                           │         │    执行到下一个通信算子 │
         │ 进入交互式调试模式       │                           │        │    等待调试进程通信     │
         └────────────────────────┘                           │         └───────────────────────┘
                   │                                          │                     │
                   │                                          │                     │
                   │                                          │                     │
                   ▼                                          │                     │
         ┌───────────────────────────┐                        ▼                     │
         │   调试完成后调用 clear_()   │              ┌────────────────────┐          │
         │ （删除 counter_file，并    │ ─────────────│    （继续后续流程）  │          │
         │  自增 BREAKPOINT_COUNTER） │              └─────────────────────┘         │
         └────────────────────────────┘                        │                     │
                   │                                           │                     │
                   │                                           │                     │
        ┌──────────▼─────────────────┐                         └─────────────────────┘
        │   删除临时文件后：           │                                       │
        │ - 等待分支（non_block=False）│                                       │
        │   检测到文件删除，解除阻塞    │                                       │
        └──────────┬──────────────────┘                          ┌────────────────────────┐
                   │                                             │    执行到下一个通信算子  │
        ┌──────────▼─────────────────┐                           │    等待调试进程通信      │
        │   执行c (continue)          │                          │                         │
        └──────────┬─────────────────┘                           └────────────────────────┘
                   │                                                           │
                   │                                                           │
                   └─────────────────────────────────────┐─────────────────────┘
                                                         ▼
                                           ┌─────────────────────────────┐
                                           │ 所有进程（调试进程、          │
                                           │  non_block=False等待分支、   │
                                           │  non_block=True直接分支）    │
                                           │ 均退出 breakpoint_()，       │
                                           │ 继续后续执行                 │
                                           └─────────────────────────────┘
```
